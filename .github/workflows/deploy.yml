name: Deploy to codeblur.dev

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run tests
        run: |
          node test-anon.js
          node test-full-flow.js
          node test-comprehensive.js

  bump-version:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Bump version
        run: |
          # Read current version (JetBrains style: YEAR.RELEASE.BUILD)
          CURRENT_YEAR=$(date +%Y)
          RELEASE=$(node -p "require('./version.json').release || 1")
          BUILD=$(node -p "require('./version.json').build || 0")

          # Increment build number
          NEW_BUILD=$((BUILD + 1))

          # Full version string
          FULL_VERSION="$CURRENT_YEAR.$RELEASE.$NEW_BUILD"

          # Update version.json
          echo "{
            \"year\": $CURRENT_YEAR,
            \"release\": $RELEASE,
            \"build\": $NEW_BUILD,
            \"version\": \"$FULL_VERSION\"
          }" > version.json

          # Update sw.js
          sed -i "s/const APP_VERSION = '.*'/const APP_VERSION = '$FULL_VERSION'/" sw.js
          sed -i "s/const BUILD_NUMBER = .*/const BUILD_NUMBER = $NEW_BUILD;/" sw.js

          # Update index.html
          sed -i "s/<span id=\"app-version\">.*<\/span>/<span id=\"app-version\">$FULL_VERSION<\/span>/" index.html

          echo "Version bumped to $FULL_VERSION"

      - name: Commit version bump
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add version.json sw.js index.html
          VERSION=$(cat version.json | node -p "JSON.parse(require('fs').readFileSync(0)).version")
          git diff --staged --quiet || git commit -m "Bump version to $VERSION"
          git push

  deploy:
    runs-on: ubuntu-latest
    needs: bump-version

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /root/src/codeblur-web
            git pull origin master
            ./deploy.sh
